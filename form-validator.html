<!DOCTYPE html>
<html>
<head>
    <title>使用策略模式验证表单</title>
</head>
<body>

    <script>

        function asyncParallelArray(
            arr,
            func,
            callback
        ) {
            const results = [];
            let total = 0;
            const arrLength = arr.length;

            function count(errors) {
                results.push(...(errors || []));
                total++;
                if (total === arrLength) {
                    callback(results);
                }
            }

            arr.forEach(a => {
                func(a, count);
            });
        }

        function asyncMap(
            objArr,
            option,
            func,
            callback,
            source
        ) {

            const objArrKeys = Object.keys(objArr);
            const objArrLength = objArrKeys.length;
            let total = 0;
            const results = [];
            const pending = new Promise((resolve, reject) => {
                const next = (errors) => {
                    // 使用array.push.apply()进行数组合并
                    results.push.apply(results, errors);
                    total++;
                    if (total === objArrLength) {
                        callback(results);
                        return results.length
                        ? reject(results)
                        : resolve(source);
                    }
                };
                objArrKeys.forEach(key => {
                    const arr = objArr[key];
                    asyncParallelArray(arr, func, next);
                });
            });
            pending.catch(e => e);
            return pending;
        }

        const descriptor = {
            username: {
                required: true,
                validator(rule, value, callback) {
                    callback(new Error('e3'));
                },
            },
            password: {
                type: 'string',
                required: true,
                message: '请填写密码'
            }
        }

        class Schema {
            rules = null;
            constructor(descriptor) {
                this.define(descriptor);
            }

            define(rules) {
                this.rules = {};

                Object.keys(rules).forEach(name => {
                    const item = rules[name];
                    this.rules[name] = Array.isArray(item) ? item : [item];
                });
            }

            validate(source_, o, oc) {
                let source= source_;
                let options = o;
                let callback = oc;
                if (typeof options === 'function') {
                    callback = options;
                    options = {};
                }

                const series = {};
                const keys = Object.keys(this.rules);

                keys.forEach(z => {
                    const arr = this.rules[z];
                    let value = source[z];
                    arr.forEach(r => {
                        let rule = r;
                        rule = { ...rule };

                        rule.field = z;
                        rule.fullField = rule.fullField || z;
                        series[z] = series[z] || [];
                        series[z].push({
                            rule,
                            value,
                            source,
                            field: z,
                        });
                    });
                });
                const errorFields = {};
                return asyncMap(
                        series,
                        options,
                        (data, doIt) => {
                            const rule = data.rule;
                            rule.field = data.field;

                            function cb(e) {
                                let errorList = Array.isArray(e) ? e : [e];
                                if (errorList.length && rule.message !== undefined) {
                                    errorList = [].concat(rule.message);
                                }
                            }

                            try {
                                res = rule.validator(rule, data.value, cb, data.source, options);
                            } catch (error) {
                                console.error(error);
                                cb(error.message);
                            }
                        })
            }
        }

    </script>
</body>
</html>